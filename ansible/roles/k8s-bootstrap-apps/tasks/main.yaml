- name: Create Shared Services Namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: shared-services
        labels:
          istio.io/dataplane-mode: ambient
  tags:
    - kubernetes
    - namespaces
    - bootstrap

- name: Create istio-system Namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: istio-system
  tags:
    - kubernetes
    - namespaces
    - istio
    - bootstrap

- name: Create security Namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: security
        labels:
          istio.io/dataplane-mode: ambient
  tags:
    - kubernetes
    - namespaces
    - security
    - bootstrap

- name: Create Cloudflare API Token Secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: cloudflare-api-token-secret
        namespace: istio-system
      type: Opaque
      stringData:
        api-token: "{{ cloudflare_api_token }}"
  no_log: true
  tags:
    - kubernetes
    - secrets
    - cloudflare
    - bootstrap

- name: Create Vault S3 credentials
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      type: generic
      metadata:
        name: vault-s3-credentials
        namespace: security
      data:
        ACCESS_KEY_ID: "{{ 'vault' | b64encode }}"
        ACCESS_SECRET_KEY: "{{ seaweedfs_vault_secret_key | trim | b64encode }}"
  no_log: true
  tags:
    - kubernetes
    - secrets
    - vault
    - bootstrap

- name: Create Seaweed S3 config Secrets
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: seaweedfs-s3-config
        namespace: shared-services
      data:
        s3-config.json: "{{ lookup('template', 'seaweedfs-s3-config.json.j2') | b64encode }}"
  no_log: true
  tags:
    - kubernetes
    - secrets
    - seaweedfs
    - bootstrap

- name: Create Seaweed Postgres credentials Secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      type: kubernetes.io/basic-auth
      metadata:
        name: seaweedfs-pg-credentials
        namespace: shared-services
      data:
        username: "{{ 'seaweedfs' | b64encode }}"
        password: "{{ seaweedfs_postgres_password | trim | b64encode }}"
  no_log: true
  tags:
    - kubernetes
    - secrets
    - seaweedfs
    - postgres
    - bootstrap

- name: Create Seaweed Backup credentials Secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: seaweedfs-backup-creds
        namespace: shared-services
      data:
        ACCESS_KEY_ID: "{{ 'pg-backup' | b64encode }}"
        ACCESS_SECRET_KEY: "{{ seaweedfs_metadata_backup_secret_key | trim | b64encode }}"
  no_log: true
  tags:
    - kubernetes
    - secrets
    - seaweedfs
    - backup
    - bootstrap

- name: Check if Flux is already bootstrapped
  kubernetes.core.k8s_info:
    kind: Namespace
    name: flux-system
  register: flux_namespace
  tags:
    - kubernetes
    - flux
    - bootstrap

- name: Bootstrap FluxCD to cluster
  ansible.builtin.command:
    cmd: >
      flux bootstrap git
      --url=ssh://git@github.com/{{ flux_github_owner }}/{{ flux_github_repo }}
      --branch={{ flux_branch }}
      --path={{ flux_path }}
      --private-key-file={{ flux_ssh_key_file | expanduser }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  delegate_to: localhost
  become: false
  when: flux_namespace.resources | length == 0
  register: flux_bootstrap_result
  changed_when: flux_bootstrap_result.rc == 0
  tags:
    - kubernetes
    - flux
    - bootstrap

- name: Wait for Flux controllers to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: flux-system
  register: flux_deployments
  until:
    - flux_deployments.resources | length > 0
    - flux_deployments.resources | selectattr('status.readyReplicas', 'defined') | list | length == flux_deployments.resources | length
    - flux_deployments.resources | map(attribute='status.readyReplicas') | select('defined') | list | length == flux_deployments.resources | length
  retries: 30
  delay: 10
  tags:
    - kubernetes
    - flux
    - bootstrap

