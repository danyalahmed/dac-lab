apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: vault
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "4"
spec:
  project: security
  source:
    repoURL: https://helm.releases.hashicorp.com
    chart: vault
    targetRevision: 0.29.1
    helm:
      valuesObject:
        server:
          image:
            repository: hashicorp/vault
            tag: "1.18.3"
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          ha:
            enabled: false
          dataStorage:
            enabled: false
          auditStorage:
            enabled: true
            size: 10Gi
            storageClass: local-path
          standalone:
            enabled: true
            config: |
              ui = true

              listener "tcp" {
                address = "[::]:8200"
                cluster_address = "[::]:8201"
                tls_disable = true
              }

              storage "s3" {
                endpoint = "http://seaweedfs-s3.shared-services.svc:8333"
                bucket = "vault-backend"
                access_key = "vault-access-key"
                secret_key = "vault-secret-key"
                s3_force_path_style = true
                region = "us-east-1"
              }

              service_registration "kubernetes" {}
        injector:
          enabled: true
  destination:
    server: https://kubernetes.default.svc
    namespace: vault
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
