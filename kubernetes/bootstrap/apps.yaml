apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: bootstrap
  namespace: argocd
spec:
  goTemplate: true
  strategy:
    type: RollingSync
    deletionOrder: Reverse
    steps:
      - matchExpressions: [{key: tier, operator: In, values: ["foundation"]}]
      - matchExpressions: [{key: tier, operator: In, values: ["operators"]}]
      - matchExpressions: [{key: tier, operator: In, values: ["data"]}]
      - matchExpressions: [{key: tier, operator: In, values: ["security"]}]
      - matchExpressions: [{key: tier, operator: In, values: ["mesh"]}]
      - matchExpressions: [{key: tier, operator: In, values: ["apps"]}]
      - matchExpressions: [{key: tier, operator: In, values: ["default"]}]
  generators:
    - matrix:
        generators:
        - git:
            repoURL: https://github.com/danyalahmed/dac-lab.git
            revision: HEAD
            files:
              - path: kubernetes/bootstrap/app-list.yaml
        - list:
            elementsYaml: '{{ .apps | toJson }}'
  template:
    metadata:
      name: '{{.name}}'
      labels:
        tier: '{{.tier}}'
    spec:
      project: '{{.project}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{.namespace}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
  templatePatch: |
    spec:
      {{- if eq .type "git" }}
      sources:
        - repoURL: '{{.repo}}'
          path: '{{.location}}'
          targetRevision: '{{.targetRevision}}'
      {{- end }}
      {{- if eq .type "helm" }}
      sources:
        - repoURL: '{{.repo}}'
          chart: '{{.chart}}'
          targetRevision: '{{.version}}'
          {{- if .hasOverride }}
          helm:
            valueFiles:
              - '$values/kubernetes/infra/{{.name}}/values.yaml'
          {{- end }}
        {{- if .hasOverride }}
        - repoURL: '{{.overridesRepo}}'
          targetRevision: HEAD
          ref: values
        {{- end }}
      {{- end }}
      {{- if eq .type "helmFromGit" }}
      sources:
        - repoURL: '{{.repo}}'
          targetRevision: '{{.version}}'
          path: '{{.location}}'
          {{- if .hasOverride }}
          helm:
            valueFiles:
              - '$values/kubernetes/infra/{{.name}}/values.yaml'
          {{- end }}
        {{- if .hasOverride }}
        - repoURL: '{{.overridesRepo}}'
          targetRevision: HEAD
          ref: values
        {{- end }}
      {{- end }}
      {{- if eq .serversideApply true }}
      syncPolicy:
        syncOptions:
          - ServerSideApply=true
      {{- end }}